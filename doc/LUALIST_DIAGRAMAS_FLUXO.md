# ğŸŒ™ Diagrama de Fluxo - LunaÃ§Ãµes via Banco de Dados

## ğŸ”„ Fluxo Completo de SincronizaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ‘¤ USUÃRIO ABRE A APP                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  app/layout.tsx    â”‚
                    â”‚  <LunationSync />  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Verificar anos [2023, 2024, 2025]   â”‚
         â”‚  Cada ano jÃ¡ estÃ¡ sincronizado?       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                    â”‚
            SIM   â”‚                    â”‚ NÃƒO
                  â–¼                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Pular este ano   â”‚ â”‚ Gerar dados localmenteâ”‚
         â”‚ (jÃ¡ no banco)    â”‚ â”‚ (365-366 dias)       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ ~500ms               â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ POST /api/moons/...  â”‚
                              â”‚ Salvar no banco      â”‚
                              â”‚ ~200ms               â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ âœ… Ano sincronizado  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ (prÃ³ximo ano)
                    â–¼
         (PrÃ³ximo ano ou concluÃ­do)
                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                     â–¼
    Outros     Pronto! Todos
    anos?      os anos
              sincronizados
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ UsuÃ¡rio abre pÃ¡gina  â”‚
         â”‚ LuaListScreen        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ fetchMoonCalendar()          â”‚
         â”‚ GET /api/moons/lunations     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                       â–¼
   Banco tem         Banco vazio?
   dados?                â”‚
    â”‚                    â–¼
    â–¼              Gerar localmente
   âœ… Usar        (fallback)
   dados do            â”‚
   banco              â–¼
    â”‚            Retornar dados
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ LuaListScreen renderizaâ”‚
  â”‚ - CalendÃ¡rio lunar     â”‚
  â”‚ - Fases da lua         â”‚
  â”‚ - Signos               â”‚
  â”‚ - IluminaÃ§Ã£o           â”‚
  â”‚ - Insights             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ğŸ‘¤ UsuÃ¡rio interage:   â”‚
  â”‚ - Clica mÃªs/fase       â”‚
  â”‚ - Adiciona insight     â”‚
  â”‚ - Salva dados          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Fluxo de Dados entre Componentes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              React Components                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ LunationSync (app/layout.tsx)            â”‚  â”‚
â”‚  â”‚ - Sincroniza automaticamente             â”‚  â”‚
â”‚  â”‚ - 0 UI                                   â”‚  â”‚
â”‚  â”‚ - Executa em background                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                â”‚
â”‚               â”‚ POST /api/moons/lunations      â”‚
â”‚               â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ LuaListScreen                            â”‚  â”‚
â”‚  â”‚ - Mostra calendÃ¡rio lunar                â”‚  â”‚
â”‚  â”‚ - Usa fetchMoonCalendar()                â”‚  â”‚
â”‚  â”‚ - Mostra fases, signos, iluminaÃ§Ã£o       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                â”‚
â”‚               â”‚ GET /api/moons/lunations       â”‚
â”‚               â–¼                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Next.js API Routes                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ /api/moons/lunations                     â”‚  â”‚
â”‚  â”‚ - GET: Busca com fallback                â”‚  â”‚
â”‚  â”‚ - POST: Salva no banco                   â”‚  â”‚
â”‚  â”‚ - source=auto|db|generated               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚              â”‚                â”‚
â”‚        Try DB â”‚              â”‚ Generate       â”‚
â”‚               â”‚              â”‚ Locally        â”‚
â”‚               â–¼              â–¼                â”‚
â”‚            Success        Return             â”‚
â”‚               â”‚              â”‚                â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                        â–¼                      â”‚
â”‚               Return to Client                â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Backend: lib/forms.ts                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ saveLunations(data)                      â”‚  â”‚
â”‚  â”‚ getLunations(start, end)                 â”‚  â”‚
â”‚  â”‚ deleteLunations(start, end)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                â”‚
â”‚               â”‚ SQL via Neon                  â”‚
â”‚               â–¼                                â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚       â”‚  PostgreSQL Neon  â”‚                   â”‚
â”‚       â”‚   (lunations)     â”‚                   â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Scripts & CLI                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ scripts/sync-lunations.js                â”‚  â”‚
â”‚  â”‚ $ node sync-lunations.js                 â”‚  â”‚
â”‚  â”‚ $ node sync-lunations.js --years=2024    â”‚  â”‚
â”‚  â”‚ $ node sync-lunations.js --replace       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                â”‚
â”‚               â”‚ Fetch local API                â”‚
â”‚               â”‚ POST dados para /api/...       â”‚
â”‚               â–¼                                â”‚
â”‚    Neon Database updated                       â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Fluxo de AutenticaÃ§Ã£o (Opcional)

Se quiser adicionar autenticaÃ§Ã£o:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/moons/lunations       â”‚
â”‚  (com autenticaÃ§Ã£o)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Verificar token               â”‚
â”‚ 2. Validar token                 â”‚
â”‚ 3. Extrair user_id               â”‚
â”‚ 4. Vincular dados ao usuÃ¡rio     â”‚
â”‚ 5. Salvar no banco               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CREATE TABLE lunations (
  ...
  user_id BIGINT,              â† Opcional
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

Atualmente, `/api/moons/lunations` **nÃ£o requer autenticaÃ§Ã£o** (Ã© pÃºblico).
Se desejar, pode adicionar `validateToken()` conforme feito em outras rotas.

---

## ğŸ“ˆ Fluxo de Performance

### Primeira ExecuÃ§Ã£o (Banco Vazio)

```
1. GET /api/moons/lunations?source=auto
                    â”‚
                    â–¼ (tenta DB)
            SELECT * FROM lunations
                    â”‚
                    â–¼
            Retorna 0 registros
                    â”‚
                    â–¼
            Gera localmente (~500ms)
                    â”‚
                    â–¼
            POST /api/moons/lunations
                    â”‚
                    â–¼
            INSERT INTO lunations (~200ms)
                    â”‚
                    â–¼
            Total: ~700ms para 365 dias
```

### ExecuÃ§Ã£o Subsequente (Banco Populado)

```
1. GET /api/moons/lunations?source=auto
                    â”‚
                    â–¼ (tenta DB)
            SELECT * FROM lunations
                    â”‚
                    â–¼
            Retorna 365 registros
                    â”‚
                    â–¼
            Envia para cliente (~50ms)
                    â”‚
                    â–¼
            Total: ~50ms (muito mais rÃ¡pido!)
```

---

## ğŸ¯ Fluxo de SincronizaÃ§Ã£o AutomÃ¡tica

```
App Carrega
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ <LunationSync autoSync />   â”‚
â”‚ mounted                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚
          â–¼               â–¼
    Para ano 1      Para ano 2
     (2023)         (2024)
          â”‚               â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚            â”‚   â”‚            â”‚
JÃ¡ feito?    NÃ£o â”‚   â”‚ JÃ¡ feito? NÃ£o
    â”‚            â–¼   â”‚   â”‚        â–¼
    â–¼        Sincronizarâ”‚   â–¼   Sincronizar
    âœ“        (500ms)    â”‚   âœ“   (500ms)
             â”‚          â”‚   â”‚
             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â”‚
                    â”‚       â”‚
               PrÃ³ximo      â”‚
                aÃ±o?        â”‚
                    â”‚       â”‚
                    â””â”€â”€â”€â”¬â”€â”€â”€â”˜
                        â”‚
                        â–¼
                  Tudo pronto!
                  
                  UI nunca trava
                  Tudo happens in background
                  LuaListScreen usa dados
```

---

## ğŸ’¾ Fluxo de Armazenamento

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Onde os dados sÃ£o armazenados?          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ 1. PostgreSQL Neon (tabela lunations)  â”‚
â”‚    â””â”€ Fonte de verdade (single source) â”‚
â”‚    â””â”€ Persistente                      â”‚
â”‚    â””â”€ Compartilhado entre usuÃ¡rios     â”‚
â”‚                                        â”‚
â”‚ 2. React State (Client-side)           â”‚
â”‚    â””â”€ TemporÃ¡rio (sessÃ£o do usuÃ¡rio)   â”‚
â”‚    â””â”€ Via hooks (useLunations)         â”‚
â”‚    â””â”€ Cache em memÃ³ria                 â”‚
â”‚                                        â”‚
â”‚ 3. localStorage (Opcional)             â”‚
â”‚    â””â”€ Para implementar cache local     â”‚
â”‚    â””â”€ Carregamento mais rÃ¡pido         â”‚
â”‚    â””â”€ Sobrevive pÃ¡gina reload          â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Fluxo de busca:
  App carrega
    â”œâ”€ Verificar localStorage â† Mais rÃ¡pido (1ms)
    â”‚
    â”œâ”€ Se vazio ou expirado
    â”‚  â”œâ”€ GET /api/moons/lunations
    â”‚  â”‚  â”œâ”€ Tentar banco â† RÃ¡pido (50ms)
    â”‚  â”‚  â”‚
    â”‚  â”‚  â””â”€ Se vazio, gerar â† OK (500ms)
    â”‚  â”‚
    â”‚  â””â”€ Salvar em localStorage
    â”‚
    â””â”€ Renderizar
```

---

## ğŸ”„ Fluxo de AtualizaÃ§Ã£o de Dados

### OpÃ§Ã£o 1: AutomÃ¡tica (Recomendada)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ <LunationSync autoSync={true} /> â”‚
â”‚ (em app/layout.tsx)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  â”‚
â”‚ Toda vez que app carrega:        â”‚
â”‚ - Verifica Ãºltimos 3 anos        â”‚
â”‚ - Sincroniza se necessÃ¡rio       â”‚
â”‚ - Tudo em background             â”‚
â”‚                                  â”‚
â”‚ Vantagens:                       â”‚
â”‚ âœ… Sempre atualizado             â”‚
â”‚ âœ… Transparente para usuÃ¡rio    â”‚
â”‚ âœ… Sem interaÃ§Ã£o necessÃ¡ria     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### OpÃ§Ã£o 2: Manual (quando necessÃ¡rio)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ <SyncButton year={2024} />       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  â”‚
â”‚ UsuÃ¡rio clica "Sincronizar"      â”‚
â”‚   â”‚                              â”‚
â”‚   â–¼                              â”‚
â”‚ useSyncLunations()               â”‚
â”‚   â”‚                              â”‚
â”‚   â”œâ”€ Gerar dados                â”‚
â”‚   â”œâ”€ POST para banco             â”‚
â”‚   â”œâ”€ Show spinner               â”‚
â”‚   â””â”€ Show success/error         â”‚
â”‚                                  â”‚
â”‚ Vantagens:                       â”‚
â”‚ âœ… Controle do usuÃ¡rio          â”‚
â”‚ âœ… Pode usar em admin panel     â”‚
â”‚ âœ… Sincronizar anos especÃ­ficos â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### OpÃ§Ã£o 3: Agendada (via cron)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend: Cron Job               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  â”‚
â”‚ Cada noite (ex: 02:00 AM):       â”‚
â”‚   â””â”€ node scripts/sync-...js     â”‚
â”‚   â””â”€ Atualiza dados do ano       â”‚
â”‚   â””â”€ Nenhuma aÃ§Ã£o do usuÃ¡rio     â”‚
â”‚                                  â”‚
â”‚ Vantagens:                       â”‚
â”‚ âœ… Dados sempre atualizados     â”‚
â”‚ âœ… Zero latÃªncia para usuÃ¡rio   â”‚
â”‚ âœ… Serverless friendly          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¡ Fluxo de IntegraÃ§Ã£o com LuaListScreen

```
LuaListScreen monta
        â”‚
        â–¼
useEffect(() => {
  ensureYearLoaded(year)
        â”‚
        â–¼
  fetchMoonCalendar({
    start: "${year}-01-01",
    end: "${year}-12-31"
  })
        â”‚
        â–¼
GET /api/moons/lunations
        â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    â–¼       â–¼
   DB     Local
   â”‚      â”‚
   â””â”€â”€â”¬â”€â”€â”€â”˜
      â”‚
      â–¼
  buildMonthEntries()
      â”‚
      â–¼
  setCalendarByYear()
      â”‚
      â–¼
  buildMoonInfo()
      â”‚
      â–¼
  Renderizar calendÃ¡rio
})
```

**Resultado:** CalendÃ¡rio lunar completo com:
- âœ… Datas de lunaÃ§Ãµes
- âœ… Fases da lua (Nova, Crescente, Cheia, Minguante)
- âœ… Signos zodiacais
- âœ… IluminaÃ§Ã£o percentual
- âœ… Interatividade (insights)

---

## ğŸš€ Fluxo de Deployment

```
Local Development
      â”‚
      â–¼
git commit
      â”‚
      â–¼
git push (branch back)
      â”‚
      â–¼
Tests & Build (CI/CD)
      â”‚
      â–¼
Pull Request / Review
      â”‚
      â–¼
Merge to main
      â”‚
      â–¼
Deploy to Production
      â”‚
      â–¼
npm run build
      â”‚
      â–¼
node scripts/sync-lunations.js
   (em produÃ§Ã£o, se necessÃ¡rio)
      â”‚
      â–¼
âœ¨ ProduÃ§Ã£o com LunaÃ§Ãµes!
```

---

**Criado em:** 13 de dezembro de 2024  
**Diagrama versÃ£o:** 1.0
